<Window x:Class="Cyber_Espace_Entrainement.Views.Users.UserGestion"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Cyber_Espace_Entrainement.Views.Users"
        xmlns:vm="clr-namespace:Cyber_Espace_Entrainement.ViewModels.Users"
        xmlns:models="clr-namespace:Cyber_Espace_Entrainement.Models"
        Title="Gestion des Utilisateurs" 
        Height="800" 
        Width="1400"
        WindowStartupLocation="CenterScreen">

        <Window.DataContext>
            <vm:UserGestionViewModel/>
        </Window.DataContext>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- EN-TÊTE avec statistiques -->
            <Border Grid.Row="0" Background="#2196F3" Padding="20">
                <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                 
                </Grid.ColumnDefinitions>
                <!-- BOUTON RETOUR (à gauche) -->
                <Button Grid.Column="0"
               Content="↩️   Retour"
               Click="BackButton_Click"
               Background="#1565C0"
               Foreground="White"
               Padding="15,10"
               FontSize="14"
               FontWeight="Bold"
               BorderThickness="0"
               Cursor="Hand"
               VerticalAlignment="Center"
               Margin="0,0,20,0"
               ToolTip="Retour au menu principal">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#1565C0"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#0D47A1"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="GESTION DES UTILISATEURS" 
                               FontSize="24" 
                               FontWeight="Bold" 
                               Foreground="White"/>
                    <TextBlock Text="Créer, modifier et supprimer des comptes" 
                               FontSize="14" 
                               Foreground="#E3F2FD" 
                               Margin="0,5,0,0"/>
                </StackPanel>

            </Grid>
            </Border>

            <!-- CONTENU PRINCIPAL -->
            <Grid Grid.Row="1" Margin="20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="400"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>


                <!-- COLONNE GAUCHE : Formulaire -->
                <Border Grid.Column="0" 
                    Background="White" 
                    BorderBrush="#ddd" 
                    BorderThickness="1" 
                    CornerRadius="8"
                    Padding="20"
                    Margin="0,0,20,0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <!-- TITRE DU FORMULAIRE (conditionnel) -->
                            <TextBlock FontSize="18" FontWeight="Bold" Margin="0,0,0,20">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="➕ Nouvel utilisateur"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                                <Setter Property="Text" Value="✏️ Modifier l'utilisateur"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <!-- Login -->
                            <TextBlock Text="Login *" FontWeight="Bold" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Login, UpdateSourceTrigger=PropertyChanged}" 
                                 Padding="8" 
                                 FontSize="14"
                                 MaxLength="30"
                                 Margin="0,0,0,15"/>

                            <!-- Mot de passe -->
                            <TextBlock Text="Mot de passe *" FontWeight="Bold" Margin="0,0,0,5"/>
                            <PasswordBox x:Name="PasswordBox" 
                                     Padding="8" 
                                     FontSize="14"
                                     MaxLength="255"
                                     PasswordChanged="PasswordBox_PasswordChanged"
                                     Margin="0,0,0,5"/>

                            <!-- Message conditionnel pour l'édition -->
                            <TextBlock FontSize="11" Foreground="#666" Margin="0,0,0,15">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Setter Property="Text" Value=""/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Setter Property="Text" Value="(Laissez vide pour ne pas modifier le mot de passe)"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <!-- Email -->
                            <TextBlock Text="Email *" FontWeight="Bold" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Email, UpdateSourceTrigger=PropertyChanged}" 
                                 Padding="8" 
                                 FontSize="14"
                                 MaxLength="100"
                                 Margin="0,0,0,15"/>

                            <!-- Rôle -->
                            <TextBlock Text="Rôle *" FontWeight="Bold" Margin="0,0,0,5"/>
                            <ComboBox SelectedItem="{Binding SelectedRole}" 
                                  Padding="8" 
                                  FontSize="14"
                                  Margin="0,0,0,20">
                                <ComboBox.Items>
                                    <models:UserRole>Etudiant</models:UserRole>
                                    <models:UserRole>Prof</models:UserRole>
                                    <models:UserRole>Admin</models:UserRole>
                                </ComboBox.Items>
                            </ComboBox>

                            <!-- Boutons -->
                            <StackPanel Orientation="Horizontal">
                                <!-- Bouton Créer/Enregistrer (conditionnel) -->
                                <Button Command="{Binding SaveUserCommand}"
                                    Background="#4CAF50"
                                    Foreground="White"
                                    Padding="20,10"
                                    FontSize="14"
                                    FontWeight="Bold"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    Margin="0,0,10,0">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Content" Value="➕ Créer"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                                    <Setter Property="Content" Value="💾 Enregistrer"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <!-- Bouton Annuler (visible seulement en mode édition) -->
                                <Button  
                                    Command="{Binding CancelEditCommand}"
                                    Background="#9E9E9E"
                                    Foreground="White"
                                    Padding="20,10"
                                    FontSize="14"
                                    BorderThickness="0"
                                    Cursor="Hand">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                        <Setter Property="Content" Value="🔄 Réinitialiser"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                                <Setter Property="Content" Value="❌ Annuler"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </Border>


                <!-- COLONNE DROITE : Liste des utilisateurs -->
                <Border Grid.Column="1" 
                    Background="White" 
                    BorderBrush="#ddd" 
                    BorderThickness="1" 
                    CornerRadius="8"
                    Padding="20">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Barre de recherche et filtres -->
                        <Grid Grid.Row="0" Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Recherche -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                     Width="300" 
                                     Padding="8"
                                     FontSize="14"
                                     VerticalContentAlignment="Center"
                                     Margin="0,0,10,0">
                                    <TextBox.InputBindings>
                                        <KeyBinding Key="Enter" Command="{Binding SearchCommand}"/>
                                    </TextBox.InputBindings>
                                </TextBox>
                                <Button Content="🔍 Rechercher" 
                                    Command="{Binding SearchCommand}"
                                    Padding="15,8"
                                    Background="#2196F3"
                                    Foreground="White"
                                    Margin="0,0,5,0"/>
                                <Button Content="↻ Réinitialiser" 
                                    Command="{Binding ResetFiltersCommand}"
                                    Padding="10,8"
                                    Background="#757575"
                                    Foreground="White"/>
                            </StackPanel>

                            <!-- Filtres rapides -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="📚 Étudiants" 
                                    Command="{Binding FilterByRoleCommand}"
                                    CommandParameter="Etudiant"
                                    Background="#4CAF50"
                                    Foreground="White"
                                    Padding="10,8"
                                    BorderThickness="0"
                                    Margin="0,0,5,0"/>
                                <Button Content="👨‍🏫 Profs" 
                                    Command="{Binding FilterByRoleCommand}"
                                    CommandParameter="Prof"
                                    Background="#FF9800"
                                    Foreground="White"
                                    Padding="10,8"
                                    BorderThickness="0"
                                    Margin="0,0,5,0"/>
                                <Button Content="⚙️ Admins" 
                                    Command="{Binding FilterByRoleCommand}"
                                    CommandParameter="Admin"
                                    Background="#FF935BF9"
                                    Foreground="White"
                                    Padding="10,8"
                                    BorderThickness="0"/>
                            </StackPanel>
                        </Grid>

                        <!-- Liste des utilisateurs -->
                        <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Users}"
                              SelectedItem="{Binding SelectedUser}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              RowHeight="50"
                              AlternatingRowBackground="#f9f9f9">

                            <DataGrid.Columns>
                                <!-- ID -->
                                <DataGridTextColumn Header="ID" 
                                                Binding="{Binding UserId}" 
                                                Width="50"/>

                                <!-- Login -->
                                <DataGridTextColumn Header="Login" 
                                                Binding="{Binding Login}" 
                                                Width="100"
                                                FontWeight="Bold"/>

                                <!-- Email -->
                                <DataGridTextColumn Header="Email" 
                                                Binding="{Binding Email}" 
                                                Width="200"/>

                                <!-- Rôle -->
                                <DataGridTextColumn Header="Rôle" 
                                                Binding="{Binding RoleDisplay}" 
                                                Width="100"/>

                                <!-- Date création -->
                                <DataGridTextColumn Header="Créé le" 
                                                Binding="{Binding DateCreation, StringFormat={}{0:dd/MM/yyyy}}" 
                                                Width="80"/>

                                <!-- Dernière connexion -->
                                <DataGridTextColumn Header="Dernière connexion" 
                                                Binding="{Binding DerniereConnexion, StringFormat={}{0:dd/MM/yyyy HH:mm}}" 
                                                Width="150"/>

                                <!-- Actions -->
                                <DataGridTemplateColumn Header="Actions" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <Button Content="✏️ Modifier" 
                                                    Command="{Binding DataContext.EditUserCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#2196F3"
                                                    Foreground="White"
                                                    Padding="10,5"
                                                    BorderThickness="0"
                                                    Margin="0,0,5,0"
                                                    Cursor="Hand"/>

                                                <Button Content="🗑️ Supprimer" 
                                                    Command="{Binding DataContext.DeleteUserCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#f44336"
                                                    Foreground="White"
                                                    Padding="10,5"
                                                    BorderThickness="0"
                                                    Cursor="Hand"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>
            </Grid>


            <!-- BARRE DE STATUT -->
            <Border Grid.Row="2" Padding="15">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="{Binding StatusColor}"/>
                    </Style>
                </Border.Style>
                <TextBlock Text="{Binding StatusMessage}" 
                       Foreground="White" 
                       FontWeight="Bold"
                       FontSize="14"/>
            </Border>
        </Grid>
    </Window>